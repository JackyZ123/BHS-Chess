{% extends 'layout.html' %}
{% block content %}

<div class="content">
    <link rel="stylesheet" href="/static/css/content.css">
    <div style="height: 100%;">
        <table>
            <tbody>
                <tr>
                    <th>White Player</th>
                    <th>Black Player</th>
                    <th>White Won</th>
                    <th></th>
                </tr>
                <tr>
                    <form action="/new_match" method="post">
                        <td><input type="text" name="white" id="white" placeholder="White Player" list="white drop"
                                onkeyup="autofill_matches('white')">
                            <datalist id="white drop">
                                {% for player in players %}
                                <option value={{player}}></option>
                                {% endfor %}
                            </datalist>
                        </td>
                        <td><input type="text" name="black" id="black" placeholder="Black Player" list="black drop">
                            <datalist id="black drop">
                                {% for player in players %}
                                <option value={{player}}></option>
                                {% endfor %}
                            </datalist>
                        </td>
                        <td>
                            <select name="winner" id="winner">
                                <option value="-1">Select a Winner</option>
                                <option value="1">White Won</option>
                                <option value="0">Black Won</option>
                                <option value="0.5">Draw</option>
                            </select>
                        </td>
                        <td><input type="submit" value="Submit"></td>
                    </form>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    var white = undefined;
    var black = undefined;

    // if click out of input for first player select the first
    document.getElementById('white').addEventListener('keyup', function (e) {
        if (e.which == 13) {
            pickFirst("white");
            select = "no id";
            this.blur();
        }
    });

    // if click out of input for second player select the first
    document.getElementById('player2').addEventListener('keyup', function (e) {
        if (e.which == 13) {
            pickFirst("black");
            select = "no id";
            this.blur();
        }
    });

    // take the most similar player to name given
    function pickFirst(caller) {
        var input = document.getElementById(caller);
        var datalist = document.getElementById(caller + " drop");

        // check if they typed anything in
        if (input.value == "")
            return;
        console.log(document.getElementById(caller + " drop").childElementCount);
        if (datalist.childElementCount > 0) {
            input.value = datalist.firstChild.value;
            if (caller == 1)
                white = datalist.firstChild.id;
            else
                black = datalist.firstChild.id;
        }
    }

    // get similar names from input
    function autofill_matches(caller) {
        var player = document.getElementById(caller).value;
        var datalist = document.getElementById(caller + " drop");

        // console.log("info")

        if (window.XMLHttpRequest) {
            var req = new XMLHttpRequest();
        }
        else {
            var req = new ActiveXObject("Microsoft.XMLHTTP");
        }

        var int_caller = 0;
        if (caller == "white") {
            int_caller = 1;
        }
        else if (caller == "black") {
            int_caller = 2;
        }

        req.open("POST", "/autofill_matches", true);
        req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        req.onreadystatechange = function () {
            // when information is returned, put it into a datalist
            if (this.readyState == 4 && this.status == 200) {
                var response = this.responseText;
                response = response.split("|");
                while (datalist.childElementCount > 0) {
                    datalist.removeChild(datalist.firstChild);
                }
                for (var i = 0; i < response.length; i++) {
                    if (response[i] == "")
                        continue;

                    response[i] = response[i].substr(1, response[i].length - 3);
                    var this_option = response[i].split(", '");
                    var option = new Option("", this_option[1]);
                    option.id = this_option[0];
                    datalist.appendChild(option);
                }
            }
        };

        req.send("data=" + player);

        // console.log("sent")
    }

    // first iteration so it functions as intended
    for (var i = 0; i < 2; i++) {
        autofill_matches(i);
    }

    var select = "no id";

    // check if they select something other than an input and pick first from datalist
    document.onselectionchange = function () {
        try {
            if (select.substr(0, 6) == "player" && document.getSelection().focusNode.firstChild.id != select) {
                pickFirst(select.substr(6, select.length));
            }

            else if (document.getSelection().focusNode.firstChild.id.substr(0, 6) == "player")
                select = document.getSelection().focusNode.firstChild.id;
            else
                select = "no id";
        }
        catch {
            select = "no id";
        }
    };

    // submit the new match
    function submit() {
        if (window.XMLHttpRequest) {
            var req = new XMLHttpRequest();
        }
        else {
            var req = new ActiveXObject("Microsoft.XMLHTTP");
        }

        // check inputs again
        for (let index = 1; index < 3; index++) {
            var input = document.getElementById("player" + (index).toString());
            var datalist = document.getElementById("p" + (index).toString() + "drop");

            if (input.value == "")
                return;
            console.log(document.getElementById("p1drop").childElementCount);
            if (datalist.childElementCount > 0) {
                input.value = datalist.firstChild.value;
                if (index == 1)
                    p1 = datalist.firstChild.id;
                else
                    p2 = datalist.firstChild.id;
            }
        }

        // send details to python file
        req.open("POST", "/new_match", true);
        req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        // req.onreadystatechange = function () {
        //     if (this.readyState == 4 && this.status == 200) {
        //         location.reload(true);
        //     }
        // };

        var winner = document.getElementById("winner").value;

        console.log(winner);

        req.send("white=" + white + "&black=" + black + "&winner=" + winner);
    }
</script>

{% endblock %}